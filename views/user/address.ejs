 <%- include('../layouts/header') %>
 <header class="header_area sticky-header">
    <div class="main_menu">
<nav class="navbar navbar-expand-lg navbar-light main_box">
    <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <a class="navbar-brand logo_h" href="index"><img src="img/logo.png" alt=""></a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
         aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse offset" id="navbarSupportedContent">
            <ul class="nav navbar-nav menu_nav ml-auto">
                <li class="nav-item "><a class="nav-link" href="/">Home</a></li>
                <li class="nav-item submenu dropdown">
                    <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
                     aria-expanded="false">Shop</a>
                    <ul class="dropdown-menu">
                        <li class="nav-item"><a class="nav-link" href="shop">Shop Category</a></li>
                        <li class="nav-item"><a class="nav-link" href="checkout">Product Checkout</a></li>
                        <li class="nav-item"><a class="nav-link" href="cart">Shopping Cart</a></li>
                    </ul>
                </li>
                <li class="nav-item submenu dropdown active">
                    <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
                     aria-expanded="false">Account</a>
                    <ul class="dropdown-menu">
                        <li class="nav-item"><a class="nav-link" href="account">Account</a></li>
                    </ul>
                </li>
                <li class="nav-item submenu dropdown">
                    <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
                     aria-expanded="false">Pages</a>
                    <ul class="dropdown-menu">
                        <% if (user) { %>
                            <li class="nav-item"><a class="nav-link" href="#">Welcome, <%= user.name %>!</a></li>
                            <li class="nav-item"><a class="nav-link" href="logout">Logout</a></li>
                        <% } else { %>
                            <li class="nav-item"><a class="nav-link" href="login">Login</a></li>
                        <% } %>
                    </ul>
                </li>
                <li class="nav-item"><a class="nav-link" href="contact">Contact</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li class="nav-item"><a href="/cart" class="cart"><span class="ti-bag"></span></a></li>
                <li class="nav-item">
                    <button class="search"><span class="lnr lnr-magnifier" id="search"></span></button>
                </li>
            </ul>
        </div>
    </div>
</nav>
</div>
<div class="search_input" id="search_input_box">
    <div class="container">
        <form class="d-flex justify-content-between">
            <input type="text" class="form-control" id="search_input" placeholder="Search Here">
            <button type="submit" class="btn"></button>
            <span class="lnr lnr-cross" id="close_search" title="Close Search"></span>
        </form>
    </div>
</div>
</header>


<section class="banner-area organic-breadcrumb">
    <div class="container">
        <div class="breadcrumb-banner d-flex flex-wrap align-items-center justify-content-end">
            <div class="col-first">
                <h1>ACCOUNT</h1>
                <nav class="d-flex align-items-center">
                    <a href="/account">Account<span class="lnr lnr-arrow-right"></span></a>
                    <a href="/address">Address</a>
                </nav>
            </div>
        </div>
    </div>
</section>

<div class="container pb-lg-5 p-l-25">
    <h4 class="ml-2 mt-2">Your Address</h4>
    <div class="row pt-4">
        <div class="col-md-4 mb-3">
            <div class="card h-100 d-flex align-items-center justify-content-center border-dashed">
                <div class="card-body text-center card-body-center">
                    <!-- Button to toggle form display -->
                    <a href="#" onclick="toggleForm()" id="toggleFormButton">
                        <span class="display-1">+</span>
                        <h5 class="card-title text-center">Add new</h5>
                    </a>
                </div>    
            </div>
        </div>

        
<% addresses.address.forEach((address, index) => { %>
    <div class="col-md-4 mb-3">
        <div class="card h-100 default-card" id="address-<%= index + 1 %>">
            <div class="card-body">
                <h4 class="card-title"><%= address.name %></h4>
                <p class="card-text"><%= address.house %> (h)</p>
                <p class="card-text"><%= address.city %>, <%= address.state %> <%= address.pincode %></p>
                <p class="card-text">India</p>
                <p class="card-text">Phone Number: <%= address.phone %></p>
            </div>
            <div class="card-footer d-flex justify-content-between">
                <a href="/loadEditAddress?addressId=<%= address._id %>" class="btn btn-link">Edit</a>
                <button type="button" class="btn btn-danger remove-address-btn" data-address-id="<%= address._id %>">
                    Remove
                </button>
                
            </div>
        </div>
    </div>
<% }) %>
            

           
            
             
         
       
        
            
        
    </div>

    <div id="addAddressForm" class="mt-lg-4" style="display: none;">
        <form id="actualAddAddressForm" method="POST">
            <div class="form-group">
                <label for="name">Name</label>  
                <input type="text" class="form-control" id="name" name="name" required>
                <small id="nameError" class="text-danger"></small>
            </div>
            <div class="form-group">
                <label for="phone">Phone</label>
                <input type="text" class="form-control" id="phone" name="phone" required>
                <small id="phoneError" class="text-danger"></small>
            </div>
            <div class="form-group">
                <label for="district">District</label>
                <input type="text" class="form-control" id="district" name="district" required>
                <small id="districtError" class="text-danger"></small>
            </div>
            <div class="form-group">
                <label for="city">City</label>
                <input type="text" class="form-control" id="city" name="city" required>
                <small id="cityError" class="text-danger"></small>
            </div>
            <div class="form-group">
                <label for="house">House</label>
                <input type="text" class="form-control" id="house" name="house" required>
                <small id="houseError" class="text-danger"></small>
            </div>
            <div class="form-group">
                <label for="state">State</label>
                <input type="text" class="form-control" id="state" name="state" required>
                <small id="stateError" class="text-danger"></small>
            </div>
            <div class="form-group">
                <label for="pincode">Pincode</label>
                <input type="text" class="form-control" id="pincode" name="pincode" required>
                <small id="pincodeError" class="text-danger"></small>
            </div>
            <button type="submit" class="btn btn-primary">Save Address</button>
            <button type="button" class="btn btn-secondary ml-2" onclick="cancelForm()">Cancel</button>
        </form>
    </div>
</div>

 <%- include('../layouts/footer') %>

    <script src="js/vendor/jquery-2.2.4.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4"
	 crossorigin="anonymous"></script>
	<script src="js/vendor/bootstrap.min.js"></script>
	<script src="js/jquery.ajaxchimp.min.js"></script>
	<script src="js/jquery.nice-select.min.js"></script>
	<script src="js/jquery.sticky.js"></script>
    <script src="js/nouislider.min.js"></script>
	<script src="js/jquery.magnific-popup.min.js"></script>
	<script src="js/owl.carousel.min.js"></script>
	<!--gmaps Js-->
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCjCGmQ0Uq4exrzdcL6rvxywDDOvfAu6eE"></script>
	<script src="js/gmaps.min.js"></script>
	<script src="js/main.js"></script>
</body>

 

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<style>
    .btn-primary {
        background: linear-gradient(45deg, #FFBA00, #FF6C00);
        border: none;
        color: white;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        border-radius: 5px;
    }

    .btn-primary:hover {
        opacity: 0.9;
    }

    .btn-primary .display-1 {
            font-size: 2.5rem;
            margin: 0;
        }

        .btn-primary .card-title {
            margin: 0;
            font-size: 1.25rem;
        }
</style>

<script>

    function cancelForm() {
        document.getElementById("addAddressForm").style.display = "none";
        document.getElementById("toggleFormButton").innerHTML = '<span class="display-1">+</span><h5 class="card-title text-center">Add new</h5>';
        resetForm();
    }

    function resetForm() {
        document.getElementById("actualAddAddressForm").reset();
        fields.forEach(field => {
            document.getElementById(`${field}Error`).innerText = '';
        });
    }

    function toggleForm() {
        var form = document.getElementById("addAddressForm");
        var button = document.getElementById("toggleFormButton");

        if (form.style.display === "none") {
            form.style.display = "block";
            button.innerHTML = '<span style="color: #666666;">Enter your details below</span>';
        } else {
            form.style.display = "none";
            button.innerHTML = '<span class="display-1">+</span><h5 class="card-title text-center">Add new</h5>';
            resetForm();
        }
    }

    // Form validation
    document.addEventListener("DOMContentLoaded", function() {
        const validationPatterns = {
            name: /^[A-Za-z]+(?: [A-Za-z]+)*$/,
            phone: /^[1-9]\d{9}$/,
            district: /^[A-Za-z]{3,}$/,
            city: /^[A-Za-z]+(?: [A-Za-z]+)*$/,
            house: /^[A-Za-z]+(?: [A-Za-z]+)*$/,
            state: /^[A-Za-z]{3,}$/,
            pincode: /^\d{6}$/
        };

        const errorMessages = {
            name: 'Name should start with a letter and contain only letters and spaces.',
            phone: 'Please provide a valid 10 digit mobile number.',
            district: 'Please provide a valid district name.',
            city: 'Please provide a valid city name.',
            house: 'Please provide a valid house name or number.',
            state: 'Please provide a valid state name.',
            pincode: 'Please provide a valid 6 digit pincode.'
        };

        const fields = Object.keys(validationPatterns);

        fields.forEach(field => {
            const input = document.getElementById(field);
            input.addEventListener('input', function () {
                const errorElement = document.getElementById(`${field}Error`);
                if (!validationPatterns[field].test(this.value)) {
                    errorElement.innerText = errorMessages[field];
                } else {
                    errorElement.innerText = '';
                }
            });
        });

        document.getElementById('actualAddAddressForm').addEventListener('submit', async function (event) {
            event.preventDefault();
            let isValid = true;

            fields.forEach(field => {
                const input = document.getElementById(field);
                const errorElement = document.getElementById(`${field}Error`);
                if (!validationPatterns[field].test(input.value.trim())) {
                    errorElement.innerText = errorMessages[field];
                    isValid = false;
                } else {
                    errorElement.innerText = '';
                }
            });

            if (!isValid) return;

            const formData = new FormData(this);
            const formEntries = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/addAddress', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formEntries)
                });

                const result = await response.json();

                if (response.status === 200) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'Address added successfully',
                        width: '300px',
                        showConfirmButton: false,
                        timer: 1500
                    });

                    setTimeout(() => {
                        location.reload();
                    }, 1500);

                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: result.error || 'Something went wrong',
                        width: '300px',
                        showConfirmButton: false,
                        timer: 1500
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: 'Something went wrong',
                    width: '300px',
                    showConfirmButton: false,
                    timer: 1500
                });
            }
        });
    });

</script>


<!-- Delete Address -->
 <style>
.swal2-icon.swal2-warning {
    font-size: 9px;
}
 </style>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const removeButtons = document.querySelectorAll('.remove-address-btn');
        
        removeButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const addressId = this.getAttribute('data-address-id');
                Swal.fire({
                    title: 'Are you sure?',
                    text: 'You will not be able to recover this address!',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        axios.delete('/deleteAddress', { addressId })
                            .then(response => {
                                Swal.fire(
                                    'Deleted!',
                                    response.data.msg,
                                    'success'
                                ).then(() => {
                                    location.reload();
                                });
                            })
                        .catch(error => {
                            Swal.fire(
                                'Error!',
                                'An error occurred while deleting the address.',
                                'error'
                            );
                            console.error('Error deleting address:', error);
                        });
                    }
                });
            });
        });
    });
</script>
